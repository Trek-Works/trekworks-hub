<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Leaving TrekWorks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #05060b;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .card {
      max-width: 420px;
      padding: 28px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      text-align: center;
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 12px;
    }
    p {
      opacity: 0.85;
      line-height: 1.5;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    a.button {
      text-decoration: none;
      padding: 10px 16px;
      border-radius: 10px;
      background: #2563eb;
      color: #fff;
      font-weight: 500;
    }
    a.secondary {
      background: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>

<div class="card">
  <h1>External link unavailable</h1>
  <p id="message">
    Checking connectionâ€¦
  </p>

  <div class="actions">
    <a class="button secondary" href="./index.html">Back to Trip</a>
  </div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  const target = params.get("url");

  function getTripMode() {
    return new Promise((resolve) => {
      const req = indexedDB.open("trekworks", 1);

      req.onerror = () => resolve("offline");

      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains("settings")) {
          db.createObjectStore("settings");
        }
      };

      req.onsuccess = () => {
        try {
          const db = req.result;
          const tx = db.transaction("settings", "readonly");
          const store = tx.objectStore("settings");
          const r = store.get("tripMode");

          r.onsuccess = () => {
            // ðŸ”’ Defensive assertion: seed IndexedDB if missing but localStorage exists
            if (r.result === undefined && localStorage.getItem("trekworks.tripMode"))
              store.put(localStorage.getItem("trekworks.tripMode"), "tripMode");

            resolve(r.result || "offline");
          };

          r.onerror = () => resolve("offline");
        } catch {
          resolve("offline");
        }
      };
    });
  }

  (async () => {
    const msg = document.getElementById("message");

    if (!target) {
      msg.textContent = "Invalid external link.";
      return;
    }

    // Authoritative Trip Mode policy
    const tripMode = await getTripMode();

    if (tripMode !== "online") {
      msg.textContent =
        "You are currently in Offline Trip Mode. External websites are unavailable.";
      return;
    }

    // Trip Mode = Online â†’ probe network BEFORE leaving app
    try {
      await fetch(target, { mode: "no-cors", cache: "no-store" });
      location.replace(target);
    } catch {
      location.replace("./offline.html");
    }
  })();
</script>

</body>
</html>
